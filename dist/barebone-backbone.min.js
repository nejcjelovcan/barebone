(function(){var e,t,n,i,r,s,a,o,c,u,l,h,p=this;"undefined"!=typeof exports?(e=require("underscore"),t=require("backbone"),"undefined"!=typeof module&&module.exports&&(module.exports=t),exports=t):(e=p._,t=p.Backbone),n=t.Model,i=t.Collection,r=n.prototype,s=i.prototype,a="change add remove reset sort destroy".split(" "),u=["reset","sort"],t.Associations={VERSION:"0.5.4"};var d=function(){return h},f=function(t){(!e.isString(t)||1>e.size(t))&&(t="."),h=t,c=RegExp("[\\"+h+"\\[\\]]+","g"),l=RegExp("[^\\"+h+"\\[\\]]+","g")};try{Object.defineProperty(t.Associations,"SEPARATOR",{enumerable:!0,get:d,set:f})}catch(y){}t.Associations.Many=t.Many="Many",t.Associations.One=t.One="One",t.Associations.Self=t.Self="Self",t.Associations.SEPARATOR=".",t.Associations.getSeparator=d,t.Associations.setSeparator=f,f(),o=t.AssociatedModel=t.Associations.AssociatedModel=n.extend({relations:void 0,_proxyCalls:void 0,get:function(e){var t=r.get.call(this,e);return t?t:this._getAttr.apply(this,arguments)},set:function(t,n,i){var r;return e.isObject(t)||null==t?(r=t,i=n):(r={},r[t]=n),t=this._set(r,i),this._processPendingEvents(),t},_set:function(t,n){var i,r,s,a,u=this;if(!t)return this;for(i in t)if(r||(r={}),i.match(c)){var l=g(i);a=e.initial(l),l=l[l.length-1],a=this.get(a),a instanceof o&&(a=r[a.cid]||(r[a.cid]={model:a,data:{}}),a.data[l]=t[i])}else a=r[this.cid]||(r[this.cid]={model:this,data:{}}),a.data[i]=t[i];if(r)for(s in r)a=r[s],this._setAttr.call(a.model,a.data,n)||(u=!1);else u=this._setAttr.call(this,t,n);return u},_setAttr:function(s,a){var c;if(a||(a={}),a.unset)for(c in s)s[c]=void 0;return this.parents=this.parents||[],this.relations&&e.each(this.relations,function(r){var c,u,l,h=r.key,p=r.relatedModel,d=r.collectionType,f=r.map,y=this.attributes[h],g=y&&y.idAttribute,_=!1;if(!p||p.prototype instanceof n||(p=e.isFunction(p)?p.call(this,r,s):p),p&&e.isString(p)&&(p=p===t.Self?this.constructor:m(p)),d&&e.isString(d)&&(d=m(d)),f&&e.isString(f)&&(f=m(f)),u=r.options?e.extend({},r.options,a):a,!p&&!d)throw Error("specify either a relatedModel or collectionType");if(s[h]){if(c=e.result(s,h),c=f?f.call(this,c,d?d:p):c,r.type===t.Many){if(d&&!d.prototype instanceof i)throw Error("collectionType must inherit from Backbone.Collection");y?(y._deferEvents=!0,y[u.reset?"reset":"set"](c instanceof i?c.models:c,u),r=y):(_=!0,c instanceof i?r=c:(r=d?new d:this._createCollection(p),r[u.reset?"reset":"set"](c,u)))}else{if(r.type!==t.One)throw Error("type attribute must be specified and have the values Backbone.One or Backbone.Many");if(!p)throw Error("specify a relatedModel for Backbone.One type");if(!(p.prototype instanceof t.AssociatedModel))throw Error("specify an AssociatedModel for Backbone.One type");r=c instanceof o?c:new p(c,u),y&&r.attributes[g]&&y.attributes[g]===r.attributes[g]?(y._deferEvents=!0,y._set(c instanceof o?c.attributes:c,u),r=y):_=!0}l=s[h]=r,(_||l&&!l._proxyCallback)&&(l._proxyCallback=function(){return this._bubbleEvent.call(this,h,l,arguments)},l.on("all",l._proxyCallback,this))}s.hasOwnProperty(h)&&(y=s[h],g=this.attributes[h],y?(y.parents=y.parents||[],-1==e.indexOf(y.parents,this)&&y.parents.push(this)):g&&g.parents.length>0&&(g.parents=e.difference(g.parents,[this]),g._proxyCallback&&g.off("all",g._proxyCallback,this)))},this),r.set.call(this,s,a)},_bubbleEvent:function(t,n,r){var s,c=r[0].split(":"),l=c[0],p="nested-change"==r[0],d=r[1],f=r[2],y=-1,m=n._proxyCalls,_=-1!==e.indexOf(a,l);if(!p){if(e.size(c)>1&&(s=c[1]),-1!==e.indexOf(u,l)&&(f=d),n instanceof i&&_&&d){var v=g(s),P=e.initial(v);(c=n.find(function(e){if(d===e)return!0;if(!e)return!1;var t=e.get(P);return(t instanceof o||t instanceof i)&&d===t?!0:(t=e.get(v),(t instanceof o||t instanceof i)&&d===t||t instanceof i&&f&&f===t?!0:void 0)}))&&(y=n.indexOf(c))}return s=t+(-1===y||"change"!==l&&!s?"":"["+y+"]")+(s?h+s:""),/\[\*\]/g.test(s)?this:(c=s.replace(/\[\d+\]/g,"[*]"),y=[],y.push.apply(y,r),y[0]=l+":"+s,m=n._proxyCalls=m||{},this._isEventAvailable.call(this,m,s)?this:(m[s]=!0,"change"===l&&(this._previousAttributes[t]=n._previousAttributes,this.changed[t]=n),this.trigger.apply(this,y),"change"===l&&this.get(s)!=r[2]&&(t=["nested-change",s,r[1]],r[2]&&t.push(r[2]),this.trigger.apply(this,t)),m&&s&&delete m[s],s!==c&&(y[0]=l+":"+c,this.trigger.apply(this,y)),this))}},_isEventAvailable:function(t,n){return e.find(t,function(e,t){return-1!==n.indexOf(t,n.length-t.length)})},_createCollection:function(t){var n=t;if(e.isString(n)&&(n=m(n)),!(n&&n.prototype instanceof o||e.isFunction(n)))throw Error("type must inherit from Backbone.AssociatedModel");return t=new i,t.model=n,t},_processPendingEvents:function(){this._processedEvents||(this._processedEvents=!0,this._deferEvents=!1,e.each(this._pendingEvents,function(e){e.c.trigger.apply(e.c,e.a)}),this._pendingEvents=[],e.each(this.relations,function(e){(e=this.attributes[e.key])&&e._processPendingEvents()},this),delete this._processedEvents)},trigger:function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):r.trigger.apply(this,arguments)},toJSON:function(t){var n,i={};return i[this.idAttribute]=this.id,this.visited||(this.visited=!0,i=r.toJSON.apply(this,arguments),this.relations&&e.each(this.relations,function(r){var s=this.attributes[r.key];s&&(n=s.toJSON?s.toJSON(t):s,i[r.key]=e.isArray(n)?e.compact(n):n)},this),delete this.visited),i},clone:function(){return new this.constructor(this.toJSON())},cleanup:function(){e.each(this.relations,function(t){(t=this.attributes[t.key])&&(t.parents=e.difference(t.parents,[this]))},this),this.off()},_getAttr:function(t){var n=this;t=g(t);var r,s;if(!(1>e.size(t))){for(s=0;t.length>s&&(r=t[s],n);s++)n=n instanceof i?isNaN(r)?void 0:n.at(r):n.attributes[r];return n}}});var g=function(t){return""===t?[""]:e.isString(t)?t.match(l):t||[]},m=function(t){return e.reduce(t.split(h),function(e,t){return e[t]},p)},_=function(t,n,i){var r,s;return e.find(t,function(t){return(r=e.find(t.relations,function(e){return t.get(e.key)===n},this))?(s=t,!0):void 0},this),r&&r.map?r.map.call(s,i,n):i},v={};e.each(["set","remove","reset"],function(e){v[e]=i.prototype[e],s[e]=function(t){return this.model.prototype instanceof o&&this.parents&&(arguments[0]=_(this.parents,this,t)),v[e].apply(this,arguments)}}),v.trigger=s.trigger,s.trigger=function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):v.trigger.apply(this,arguments)},s._processPendingEvents=o.prototype._processPendingEvents}).call(this),function(e,t){"use strict";if(e===void 0&&(e={}),n===void 0)var n={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",types:{string:{setter:function(e){return""+e}},"boolean":{setter:function(e){return!!e}},integer:{setter:function(e){return parseInt(e,10)}},"float":{setter:function(e){return parseFloat(e)}},datetime:{setter:function(e){return Date.prototype.isPrototypeOf(e)?e:new Date(e)}}},queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),_(e.config.schemas||{}).each(function(t,n){e.config.addSchema(n,t)}),e.QueryParams=t.Model.extend({initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){this.set("page",this.get("page")+1)},prevPage:function(){this.set("page",this.get("page")-1)}},{serialize:function(t){var n={};return _(t).each(function(t,i){e.config.queryParamsMap[i]&&(i=e.config.queryParamsMap[i]),n[i]=t===!0?"True":t===!1?"False":t}),n}}),e.TQueried={initQueryParams:function(e){e||(e={}),this.setQueryParams(e.queryParams||{},{fetch:!1})},setQueryParams:function(t,n){var i;"object"!=typeof t?(i={},i[t]=n,n=null):i=t,n||(n={}),this.queryParams&&e.QueryParams.prototype.isPrototypeOf(this.queryParams)||(this.queryParams=new e.QueryParams(this.queryParams||{},{parent:this})),this.queryParams.set(i,{silent:n.fetch===!1||n.silent===!0})},parse:function(n){if(t.Collection.prototype.isPrototypeOf(this)){if(_(n).isArray())return n;var i=n[e.config.responseParamsMap.count];return i!==void 0&&this.setQueryParams({count:i}),n[e.config.responseParamsMap.results]}return n}},e.expandSchema=function(t){for(var n in t)t.hasOwnProperty(n)&&(t[n]=_({}).extend((t[n].type?e.config.types[t[n].type]:null)||{},t[n]));return t},e.MSchemed={get:function(t,n){n||(n={});var i=e.Model.__super__.get.apply(this,[t,n]);return this.schema&&n.raw!==!0&&t in this.schema&&this.schema[t].getter?this.schema[t].getter(i,n,this.schema[t]):i},set:function(t,n){if("object"!=typeof t){var i={};i[t]=n,n=null,t=i}if(n||(n={}),this.schema&&n.raw!==!0)for(var r in t)r in this.schema&&this.schema[r].setter&&(t[r]=this.schema[r].setter(t[r],n,this.schema[r]));return e.Model.__super__.set.apply(this,[t,n])}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,e.MSchemed,{modelName:"model",constructor:function(e,n){("AssociatedModel"in t?t.AssociatedModel:t.Model).apply(this,[e,n]),this.initQueryParams(n)},onceSet:function(e,t,n){return this.has(e)?t.apply(n,[this,this.get(e)]):this.once("change:"+e,t,n),this}}),{extend:function(n,i){if(n.schema&&(n.schema=_({}).extend(this.schema||{},e.expandSchema(n.schema)),t.AssociatedModel)){var r,s=[];for(var a in n.schema)n.schema.hasOwnProperty(a)&&(r=n.schema[a],"relation"===r.type&&s.push({type:"many"===r.relatedType?t.Many:t.One,relatedModel:r.relatedModel,key:a}));s.length&&(n.relations=s)}return t.Model.extend.apply(this,[n,i])}}),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{constructor:function(e,n){t.Collection.apply(this,[e,n]),this.initQueryParams(n)}}));var i=t.sync;e.sync_api=function(n,r,s){var a=_({}).extend(_(e.config).result("queryParams")),o=t.Model.prototype.isPrototypeOf(r);return o?r.modelName:r.model&&r.model.modelName,r.queryParams?_(a).extend(r.queryParams.getForQuery()):o&&r.collection&&r.collection.queryParams&&_(a).extend(r.collection.queryParams.getForQuery(!0)),_(a).extend(s.queryParams||{}),s.url=(s.url||r.urlRoot||r.model&&r.model.urlRoot||r.collection&&r.collection.urlRoot)+(o&&r.has("id")?r.get("id"):""),window.params=[s.url+"",r.url,r.urlRoot,r.model&&r.model.prototype.urlRoot],s.url+="?"+$.param(e.QueryParams.serialize(a)),i(n,r,s)},t.sync=e.sync_api}(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);