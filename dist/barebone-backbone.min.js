(function(){var e,t,i,n,r,s,o,a,c,u,l,h,p=this;"undefined"!=typeof exports?(e=require("underscore"),t=require("backbone"),"undefined"!=typeof module&&module.exports&&(module.exports=t),exports=t):(e=p._,t=p.Backbone),i=t.Model,n=t.Collection,r=i.prototype,s=n.prototype,o="change add remove reset sort destroy".split(" "),u=["reset","sort"],t.Associations={VERSION:"0.5.4"};var d=function(){return h},f=function(t){(!e.isString(t)||1>e.size(t))&&(t="."),h=t,c=RegExp("[\\"+h+"\\[\\]]+","g"),l=RegExp("[^\\"+h+"\\[\\]]+","g")};try{Object.defineProperty(t.Associations,"SEPARATOR",{enumerable:!0,get:d,set:f})}catch(g){}t.Associations.Many=t.Many="Many",t.Associations.One=t.One="One",t.Associations.Self=t.Self="Self",t.Associations.SEPARATOR=".",t.Associations.getSeparator=d,t.Associations.setSeparator=f,f(),a=t.AssociatedModel=t.Associations.AssociatedModel=i.extend({relations:void 0,_proxyCalls:void 0,get:function(e){var t=r.get.call(this,e);return t?t:this._getAttr.apply(this,arguments)},set:function(t,i,n){var r;return e.isObject(t)||null==t?(r=t,n=i):(r={},r[t]=i),t=this._set(r,n),this._processPendingEvents(),t},_set:function(t,i){var n,r,s,o,u=this;if(!t)return this;for(n in t)if(r||(r={}),n.match(c)){var l=y(n);o=e.initial(l),l=l[l.length-1],o=this.get(o),o instanceof a&&(o=r[o.cid]||(r[o.cid]={model:o,data:{}}),o.data[l]=t[n])}else o=r[this.cid]||(r[this.cid]={model:this,data:{}}),o.data[n]=t[n];if(r)for(s in r)o=r[s],this._setAttr.call(o.model,o.data,i)||(u=!1);else u=this._setAttr.call(this,t,i);return u},_setAttr:function(s,o){var c;if(o||(o={}),o.unset)for(c in s)s[c]=void 0;return this.parents=this.parents||[],this.relations&&e.each(this.relations,function(r){var c,u,l,h=r.key,p=r.relatedModel,d=r.collectionType,f=r.map,g=this.attributes[h],y=g&&g.idAttribute,_=!1;if(!p||p.prototype instanceof i||(p=e.isFunction(p)?p.call(this,r,s):p),p&&e.isString(p)&&(p=p===t.Self?this.constructor:m(p)),d&&e.isString(d)&&(d=m(d)),f&&e.isString(f)&&(f=m(f)),u=r.options?e.extend({},r.options,o):o,!p&&!d)throw Error("specify either a relatedModel or collectionType");if(s[h]){if(c=e.result(s,h),c=f?f.call(this,c,d?d:p):c,r.type===t.Many){if(d&&!d.prototype instanceof n)throw Error("collectionType must inherit from Backbone.Collection");g?(g._deferEvents=!0,g[u.reset?"reset":"set"](c instanceof n?c.models:c,u),r=g):(_=!0,c instanceof n?r=c:(r=d?new d:this._createCollection(p),r[u.reset?"reset":"set"](c,u)))}else{if(r.type!==t.One)throw Error("type attribute must be specified and have the values Backbone.One or Backbone.Many");if(!p)throw Error("specify a relatedModel for Backbone.One type");if(!(p.prototype instanceof t.AssociatedModel))throw Error("specify an AssociatedModel for Backbone.One type");r=c instanceof a?c:new p(c,u),g&&r.attributes[y]&&g.attributes[y]===r.attributes[y]?(g._deferEvents=!0,g._set(c instanceof a?c.attributes:c,u),r=g):_=!0}l=s[h]=r,(_||l&&!l._proxyCallback)&&(l._proxyCallback=function(){return this._bubbleEvent.call(this,h,l,arguments)},l.on("all",l._proxyCallback,this))}s.hasOwnProperty(h)&&(g=s[h],y=this.attributes[h],g?(g.parents=g.parents||[],-1==e.indexOf(g.parents,this)&&g.parents.push(this)):y&&y.parents.length>0&&(y.parents=e.difference(y.parents,[this]),y._proxyCallback&&y.off("all",y._proxyCallback,this)))},this),r.set.call(this,s,o)},_bubbleEvent:function(t,i,r){var s,c=r[0].split(":"),l=c[0],p="nested-change"==r[0],d=r[1],f=r[2],g=-1,m=i._proxyCalls,_=-1!==e.indexOf(o,l);if(!p){if(e.size(c)>1&&(s=c[1]),-1!==e.indexOf(u,l)&&(f=d),i instanceof n&&_&&d){var v=y(s),P=e.initial(v);(c=i.find(function(e){if(d===e)return!0;if(!e)return!1;var t=e.get(P);return(t instanceof a||t instanceof n)&&d===t?!0:(t=e.get(v),(t instanceof a||t instanceof n)&&d===t||t instanceof n&&f&&f===t?!0:void 0)}))&&(g=i.indexOf(c))}return s=t+(-1===g||"change"!==l&&!s?"":"["+g+"]")+(s?h+s:""),/\[\*\]/g.test(s)?this:(c=s.replace(/\[\d+\]/g,"[*]"),g=[],g.push.apply(g,r),g[0]=l+":"+s,m=i._proxyCalls=m||{},this._isEventAvailable.call(this,m,s)?this:(m[s]=!0,"change"===l&&(this._previousAttributes[t]=i._previousAttributes,this.changed[t]=i),this.trigger.apply(this,g),"change"===l&&this.get(s)!=r[2]&&(t=["nested-change",s,r[1]],r[2]&&t.push(r[2]),this.trigger.apply(this,t)),m&&s&&delete m[s],s!==c&&(g[0]=l+":"+c,this.trigger.apply(this,g)),this))}},_isEventAvailable:function(t,i){return e.find(t,function(e,t){return-1!==i.indexOf(t,i.length-t.length)})},_createCollection:function(t){var i=t;if(e.isString(i)&&(i=m(i)),!(i&&i.prototype instanceof a||e.isFunction(i)))throw Error("type must inherit from Backbone.AssociatedModel");return t=new n,t.model=i,t},_processPendingEvents:function(){this._processedEvents||(this._processedEvents=!0,this._deferEvents=!1,e.each(this._pendingEvents,function(e){e.c.trigger.apply(e.c,e.a)}),this._pendingEvents=[],e.each(this.relations,function(e){(e=this.attributes[e.key])&&e._processPendingEvents()},this),delete this._processedEvents)},trigger:function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):r.trigger.apply(this,arguments)},toJSON:function(t){var i,n={};return n[this.idAttribute]=this.id,this.visited||(this.visited=!0,n=r.toJSON.apply(this,arguments),this.relations&&e.each(this.relations,function(r){var s=this.attributes[r.key];s&&(i=s.toJSON?s.toJSON(t):s,n[r.key]=e.isArray(i)?e.compact(i):i)},this),delete this.visited),n},clone:function(){return new this.constructor(this.toJSON())},cleanup:function(){e.each(this.relations,function(t){(t=this.attributes[t.key])&&(t.parents=e.difference(t.parents,[this]))},this),this.off()},_getAttr:function(t){var i=this;t=y(t);var r,s;if(!(1>e.size(t))){for(s=0;t.length>s&&(r=t[s],i);s++)i=i instanceof n?isNaN(r)?void 0:i.at(r):i.attributes[r];return i}}});var y=function(t){return""===t?[""]:e.isString(t)?t.match(l):t||[]},m=function(t){return e.reduce(t.split(h),function(e,t){return e[t]},p)},_=function(t,i,n){var r,s;return e.find(t,function(t){return(r=e.find(t.relations,function(e){return t.get(e.key)===i},this))?(s=t,!0):void 0},this),r&&r.map?r.map.call(s,n,i):n},v={};e.each(["set","remove","reset"],function(e){v[e]=n.prototype[e],s[e]=function(t){return this.model.prototype instanceof a&&this.parents&&(arguments[0]=_(this.parents,this,t)),v[e].apply(this,arguments)}}),v.trigger=s.trigger,s.trigger=function(){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):v.trigger.apply(this,arguments)},s._processPendingEvents=a.prototype._processPendingEvents}).call(this),function(e,t){"use strict";if(e===void 0&&(e={}),i===void 0)var i={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),e.QueryParams=t.Model.extend({initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){this.set("page",this.get("page")+1)},prevPage:function(){this.set("page",this.get("page")-1)}},{serialize:function(t){var i={};return _(t).each(function(t,n){e.config.queryParamsMap[n]&&(n=e.config.queryParamsMap[n]),i[n]=t===!0?"True":t===!1?"False":t}),i}}),e.TQueried={initQueryParams:function(e){e||(e={}),this.setQueryParams(e.queryParams||{},{fetch:!1})},setQueryParams:function(t,i){var n;"object"!=typeof t?(n={},n[t]=i,i=null):n=t,i||(i={}),this.queryParams&&e.QueryParams.prototype.isPrototypeOf(this.queryParams)||(this.queryParams=new e.QueryParams(this.queryParams||{},{parent:this})),this.queryParams.set(n,{silent:i.fetch===!1||i.silent===!0})},parse:function(i){if(t.Collection.prototype.isPrototypeOf(this)){if(_(i).isArray())return i;var n=i[e.config.responseParamsMap.count];return n!==void 0&&this.setQueryParams({count:n}),i[e.config.responseParamsMap.results]}return i}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,{modelName:"model",constructor:function(e,i){("AssociatedModel"in t?t.AssociatedModel:t.Model).apply(this,[e,i]),this.initQueryParams(i)},onceSet:function(e,t,i){return this.has(e)?t.apply(i,[this,this.get(e)]):this.once("change:"+e,t,i),this}})),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{constructor:function(e,i){t.Collection.apply(this,[e,i]),this.initQueryParams(i)}}));var n=t.sync;e.sync_api=function(i,r,s){var o=_({}).extend(_(e.config).result("queryParams")),a=t.Model.prototype.isPrototypeOf(r);return a?r.modelName:r.model&&r.model.modelName,r.queryParams?_(o).extend(r.queryParams.getForQuery()):a&&r.collection&&r.collection.queryParams&&_(o).extend(r.collection.queryParams.getForQuery(!0)),_(o).extend(s.queryParams||{}),s.url=(s.url||r.urlRoot||r.model&&r.model.urlRoot||r.collection&&r.collection.urlRoot)+(a&&r.has("id")?r.get("id"):""),window.params=[s.url+"",r.url,r.urlRoot,r.model&&r.model.prototype.urlRoot],s.url+="?"+$.param(e.QueryParams.serialize(o)),n(i,r,s)},t.sync=e.sync_api}(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);