(function(e,t){"use strict";if(e===void 0&&(e={}),r===void 0)var r={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",types:{string:{setter:function(e){return""+e}},"boolean":{setter:function(e){return!!e}},integer:{setter:function(e){return parseInt(e,10)}},"float":{setter:function(e){return parseFloat(e)}},datetime:{setter:function(e){return Date.prototype.isPrototypeOf(e)?e:new Date(e)}}},queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),_(e.config.schemas||{}).each(function(t,r){e.config.addSchema(r,t)}),e.QueryParams=t.Model.extend({initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){this.set("page",this.get("page")+1)},prevPage:function(){this.set("page",this.get("page")-1)}},{serialize:function(t){var r={};return _(t).each(function(t,a){e.config.queryParamsMap[a]&&(a=e.config.queryParamsMap[a]),r[a]=t===!0?"True":t===!1?"False":t}),r}}),e.TQueried={initQueryParams:function(e){e||(e={}),this.setQueryParams(e.queryParams||{},{fetch:!1})},setQueryParams:function(t,r){var a;"object"!=typeof t?(a={},a[t]=r,r=null):a=t,r||(r={}),this.queryParams&&e.QueryParams.prototype.isPrototypeOf(this.queryParams)||(this.queryParams=new e.QueryParams(this.queryParams||{},{parent:this})),this.queryParams.set(a,{silent:r.fetch===!1||r.silent===!0})},parse:function(r){if(t.Collection.prototype.isPrototypeOf(this)){if(_(r).isArray())return r;var a=r[e.config.responseParamsMap.count];return a!==void 0&&this.setQueryParams({count:a}),r[e.config.responseParamsMap.results]}return r}},e.expandSchema=function(t){for(var r in t)t.hasOwnProperty(r)&&(t[r]=_({}).extend((t[r].type?e.config.types[t[r].type]:null)||{},t[r]));return t},e.MSchemed={get:function(t,r){r||(r={});var a=e.Model.__super__.get.apply(this,[t,r]);return this.schema&&r.raw!==!0&&t in this.schema&&this.schema[t].getter?this.schema[t].getter(a,r,this.schema[t]):a},set:function(t,r){if("object"!=typeof t){var a={};a[t]=r,r=null,t=a}if(r||(r={}),this.schema&&r.raw!==!0)for(var n in t)n in this.schema&&this.schema[n].setter&&(t[n]=this.schema[n].setter(t[n],r,this.schema[n]));return e.Model.__super__.set.apply(this,[t,r])}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,e.MSchemed,{modelName:"model",constructor:function(e,r){("AssociatedModel"in t?t.AssociatedModel:t.Model).apply(this,[e,r]),this.initQueryParams(r)},onceSet:function(e,t,r){return this.has(e)?t.apply(r,[this,this.get(e)]):this.once("change:"+e,t,r),this}}),{extend:function(r,a){if(r.schema&&(r.schema=_({}).extend(this.schema||{},e.expandSchema(r.schema)),t.AssociatedModel)){var n,i=[];for(var s in r.schema)r.schema.hasOwnProperty(s)&&(n=r.schema[s],"relation"===n.type&&i.push({type:"many"===n.relatedType?t.Many:t.One,relatedModel:n.relatedModel,key:s}));i.length&&(r.relations=i)}return t.Model.extend.apply(this,[r,a])}}),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{constructor:function(e,r){t.Collection.apply(this,[e,r]),this.initQueryParams(r)}}));var a=t.sync;e.sync_api=function(r,n,i){var s=_({}).extend(_(e.config).result("queryParams")),o=t.Model.prototype.isPrototypeOf(n);return o?n.modelName:n.model&&n.model.modelName,n.queryParams?_(s).extend(n.queryParams.getForQuery()):o&&n.collection&&n.collection.queryParams&&_(s).extend(n.collection.queryParams.getForQuery(!0)),_(s).extend(i.queryParams||{}),i.url=(i.url||n.urlRoot||n.model&&n.model.urlRoot||n.collection&&n.collection.urlRoot)+(o&&n.has("id")?n.get("id"):""),window.params=[i.url+"",n.url,n.urlRoot,n.model&&n.model.prototype.urlRoot],i.url+="?"+$.param(e.QueryParams.serialize(s)),a(r,n,i)},t.sync=e.sync_api})(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);