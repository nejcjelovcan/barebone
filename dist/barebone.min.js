(function(e,t){"use strict";if(e===void 0&&(e={}),i===void 0)var i={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",dbString:"pg://talmai@localhost/odalisca",dbClient:null,types:{string:{setter:function(e){return""+e}},"boolean":{setter:function(e){return!!e}},integer:{setter:function(e){return parseInt(e,10)}},"float":{setter:function(e){return parseFloat(e)}},datetime:{setter:function(e){return Date.prototype.isPrototypeOf(e)?e:new Date(e)}}},queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"ordering"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),_(e.config.schemas||{}).each(function(t,i){e.config.addSchema(i,t)}),e.QueryParams=t.Model.extend({initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){this.set("page",this.get("page")+1)},prevPage:function(){this.set("page",this.get("page")-1)}},{serialize:function(t){var i={};return _(t||this.attributes).each(function(t,r){e.config.queryParametersMap[r]?r=e.config.queryParametersMap[r]:i[r]=t===!0?"True":t===!1?"False":this.attributes}),i}}),e.TQueried={initQueryParams:function(e){e||(e={}),e.queryParams&&this.setQueryParams(e.queryParams,{fetch:!1})},setQueryParams:function(t,i){var r;"object"!=typeof t?(r={},r[t]=i,i=null):r=t,i||(i={}),this.queryParams||(this.queryParams=new e.QueryParams({},{parent:this})),this.queryParams.set(r,{silent:i.fetch===!1||i.silent===!0})},parse:function(i){if(t.Collection.prototype.isPrototypeOf(this)){var r=i[e.config.responseParamsMap.count];return r!==void 0&&this.setQueryParams({count:r}),i[e.config.responseParamsMap.results]}return i}},e.expandSchema=function(t){for(var i in t)t.hasOwnProperty(i)&&(t[i]=_({}).extend((t[i].type?e.config.types[t[i].type]:null)||{},t[i]));return t},e.MSchemed={get:function(t,i){i||(i={});var r=e.Model.__super__.get.apply(this,[t,i]);return this.schema&&i.raw!==!0&&t in this.schema&&this.schema[t].getter?this.schema[t].getter(r,i,this.schema[t]):r},set:function(t,i){if("object"!=typeof t){var r={};r[t]=i,i=null,t=r}if(i||(i={}),this.schema&&i.raw!==!0)for(var a in t)a in this.schema&&this.schema[a].setter&&(t[a]=this.schema[a].setter(t[a],i,this.schema[a]));return e.Model.__super__.set.apply(this,[t,i])}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,e.MSchemed,{modelName:"model",initialize:function(e,i){("AssociatedModel"in t?t.AssociatedModel:t.Model).prototype.initialize.apply(this,[e,i]),this.initQueryParams(i)},onceSet:function(e,t,i){return this.has(e)?t.apply(i,[this,this.get(e)]):this.once("change:"+e,t,i),this}}),{extend:function(i,r){if(i.schema&&(i.schema=_({}).extend(this.schema||{},e.expandSchema(i.schema)),t.AssociatedModel)){var a,n=[];for(var s in i.schema)i.schema.hasOwnProperty(s)&&(a=i.schema[s],"relation"===a.type&&n.push({type:"many"===a.relatedType?t.Many:t.One,relatedModel:a.relatedModel,key:s}));n.length&&(i.relations=n)}return t.Model.extend.apply(this,[i,r])}}),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{initialize:function(e,i){t.Collection.prototype.initialize.apply(this,[e,i]),this.initQueryParams(i)}}));var r=t.sync;e.sync_api=function(a,n,s){var o=_({}).extend(_(e.config).result("queryParams")),c=t.Model.prototype.isPrototypeOf(n),u=c?n.modelName:n.model&&n.model.modelName;return n.queryParams?_(o).extend(n.queryParams.getForQuery()):c&&n.collection&&n.collection.queryParams&&_(o).extend(n.collection.queryParams.getForQuery(!0)),_(o).extend(s.queryParams||{}),s.url=s.url||_(n).result("url")||e.config.urlRoot+u+"/"+(c&&n.has("id")?n.get("id"):""),s.url+="?"+$.param(e.QueryParams.serialize(o)),i.log("BACKBONE.SYNC",a,n,s),r(a,n,s)}})(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);