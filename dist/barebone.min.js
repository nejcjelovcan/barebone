(function(e,t){"use strict";if(e===void 0&&(e={}),r===void 0)var r={log:function(){},error:function(){},trace:function(){}};e.config=_(e.config||{}).extend({urlRoot:"/site/api/",types:{string:{setter:function(e){return""+e}},"boolean":{setter:function(e){return!!e}},integer:{setter:function(e){return parseInt(e,10)}},"float":{setter:function(e){return parseFloat(e)}},datetime:{setter:function(e){return Date.prototype.isPrototypeOf(e)?e:new Date(e)}}},queryParams:{},queryParamsMap:{serializer:"serializer",pageSize:"page_size",page:"page",ordering:"order"},responseParamsMap:{count:"count",results:"results"},defaultPageSize:50}),_(e.config.schemas||{}).each(function(t,r){e.config.addSchema(r,t)}),e.QueryParams=t.Model.extend({initialize:function(e,t){_(this).bindAll("on_change"),t||(t={}),this.parent=t.parent,this.on("change",this.on_change)},on_change:function(){var e=this.changedAttributes();e&&1===_(e).keys().length&&"count"in e||this.parent&&this.parent.fetch()},getForQuery:function(e){return e?_(this.attributes).pick("serializer"):_(this.attributes).omit("count")},getPages:function(){return Math.ceil(this.get("count")/this.get("pageSize")||e.config.defaultPageSize)},nextPage:function(){this.set("page",this.get("page")+1)},prevPage:function(){this.set("page",this.get("page")-1)}},{serialize:function(t){var r={};return _(t).each(function(t,i){e.config.queryParamsMap[i]&&(i=e.config.queryParamsMap[i]),r[i]=t===!0?"True":t===!1?"False":t}),r}}),e.TQueried={initQueryParams:function(e){e||(e={}),e.queryParams&&this.setQueryParams(e.queryParams,{fetch:!1})},setQueryParams:function(t,r){var i;"object"!=typeof t?(i={},i[t]=r,r=null):i=t,r||(r={}),this.queryParams||(this.queryParams=new e.QueryParams({},{parent:this})),this.queryParams.set(i,{silent:r.fetch===!1||r.silent===!0})},parse:function(r){if(t.Collection.prototype.isPrototypeOf(this)){if(_(r).isArray())return r;var i=r[e.config.responseParamsMap.count];return i!==void 0&&this.setQueryParams({count:i}),r[e.config.responseParamsMap.results]}return r}},e.expandSchema=function(t){for(var r in t)t.hasOwnProperty(r)&&(t[r]=_({}).extend((t[r].type?e.config.types[t[r].type]:null)||{},t[r]));return t},e.MSchemed={get:function(t,r){r||(r={});var i=e.Model.__super__.get.apply(this,[t,r]);return this.schema&&r.raw!==!0&&t in this.schema&&this.schema[t].getter?this.schema[t].getter(i,r,this.schema[t]):i},set:function(t,r){if("object"!=typeof t){var i={};i[t]=r,r=null,t=i}if(r||(r={}),this.schema&&r.raw!==!0)for(var a in t)a in this.schema&&this.schema[a].setter&&(t[a]=this.schema[a].setter(t[a],r,this.schema[a]));return e.Model.__super__.set.apply(this,[t,r])}},e.Model=("AssociatedModel"in t?t.AssociatedModel:t.Model).extend(_({}).extend(e.TQueried,e.MSchemed,{modelName:"model",initialize:function(e,r){("AssociatedModel"in t?t.AssociatedModel:t.Model).prototype.initialize.apply(this,[e,r]),this.initQueryParams(r)},onceSet:function(e,t,r){return this.has(e)?t.apply(r,[this,this.get(e)]):this.once("change:"+e,t,r),this}}),{extend:function(r,i){if(r.schema&&(r.schema=_({}).extend(this.schema||{},e.expandSchema(r.schema)),t.AssociatedModel)){var a,n=[];for(var s in r.schema)r.schema.hasOwnProperty(s)&&(a=r.schema[s],"relation"===a.type&&n.push({type:"many"===a.relatedType?t.Many:t.One,relatedModel:a.relatedModel,key:s}));n.length&&(r.relations=n)}return t.Model.extend.apply(this,[r,i])}}),e.Collection=t.Collection.extend(_({}).extend(e.TQueried,{initialize:function(e,r){t.Collection.prototype.initialize.apply(this,[e,r]),this.initQueryParams(r)}}));var i=t.sync;e.sync_api=function(r,a,n){var s=_({}).extend(_(e.config).result("queryParams")),o=t.Model.prototype.isPrototypeOf(a),c=o?a.modelName:a.model&&a.model.modelName;return a.queryParams?_(s).extend(a.queryParams.getForQuery()):o&&a.collection&&a.collection.queryParams&&_(s).extend(a.collection.queryParams.getForQuery(!0)),_(s).extend(n.queryParams||{}),n.url=n.url||_(a).result("url")||e.config.urlRoot+c+"/"+(o&&a.has("id")?a.get("id"):""),n.url+="?"+$.param(e.QueryParams.serialize(s)),i(r,a,n)}})(window.barebone===void 0?window.barebone={}:window.barebone,Backbone,jQuery);